<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QOS STATS</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.2/echarts.min.js"></script>
  <style>
    .container {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      justify-content: left;
    }
    .item {
      margin: 10px;
      flex-basis: calc(50% - 20px);
      max-width: calc(50% - 20px);
      height: 250px;
    }
    @media (max-width: 900px) {
      .item {
        flex-basis: calc(100% - 20px);
        max-width: calc(100% - 20px);
      }
    }
  </style>
</head>
<body>

<div class="container">
  <div class="item" id="bwe"></div>
  <div class="item" id="trend"></div>
  <div class="item" id="rtt"></div>
  <div class="item" id="loss"></div>
  <div class="item" id="rate"></div>
  <div class="item" id="sendFrameRate"></div>
  <div class="item" id="recvFrameRate"></div>
  <div class="item" id="nackCount"></div>
  <div class="item" id="nackDuration"></div>
  <div class="item" id="cost0"></div>
  <div class="item" id="cost1"></div>
</div>

<script type="text/javascript">
  const echartsInstances = {};
  const chartIds = ['bwe', 'trend', 'rtt', 'loss', 'rate', 'sendFrameRate', 'recvFrameRate', 'nackCount', 'nackDuration', 'cost0', 'cost1'];
  chartIds.forEach(id => {
    echartsInstances[id] = echarts.init(document.getElementById(id));
  });

  function resizeCharts() {
    Object.values(echartsInstances).forEach(instance => instance.resize());
  }

  window.addEventListener('resize', resizeCharts);
  resizeCharts();

  const commonOptions = {
    tooltip: { trigger: "axis" },
    dataZoom: [{ type: 'slider' }, { type: 'inside' }],
    grid: { left: "3%", right: "4%", bottom: "3%", containLabel: true },
    toolbox: { feature: { saveAsImage: {} } },
    xAxis: { type: "category", boundaryGap: false, data: [] },
    yAxis: { type: "value" },
    series: []
  };

  function setOption(chartId, option) {
    const instance = echartsInstances[chartId];
    instance.setOption({ ...commonOptions, ...option });
  }

  let ws = null;
  window.onload = connectWS();

  function parseResponse(response) {
    if (response.success !== true) return;
    const result = JSON.parse(response.payload);
    const option = {
      title: { text: response.statsType },
      legend: { data: result.legend },
      xAxis: { data: result.xAxis },
      series: result.series.map((data, index) => ({
        name: result.legend[index],
        type: result.seriesType[index],
        data: data
      }))
    };
    setOption(response.statsType, option);
  }

  async function connectWS() {
    if (ws == null) {
      const ip = window.location.host;
      const queryString = window.location.search;
      const urlParams = new URLSearchParams(queryString);
      const id = urlParams.get('id');
      ws = new WebSocket(`ws://${ip}/ws/stats?id=${id}`);
    }

    ws.onmessage = function (evt) {
      parseResponse(JSON.parse(evt.data));
    }
  }

  function closeWS() {
    ws.close();
  }
</script>

</body>
</html>